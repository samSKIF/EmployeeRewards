  app.get("/api/hr/template/download-test", verifyToken, async (req: AuthenticatedRequest, res) => {
    try {
      console.log("Template test download request received, user:", req.user?.email);
      
      // Check if the employee template exists in the database
      const [template] = await db
        .select()
        .from(fileTemplates)
        .where(eq(fileTemplates.name, 'employee_import'));
      
      // Set up the CSV content - either from database or default
      let csvContent;
      
      if (template) {
        // If template exists in database, use it
        csvContent = template.content;
      } else {
        // Use hardcoded fallback if no template exists yet
        // Create CSV header row (no BOM)
        const headers = "name,surname,email,password,dateOfBirth,dateJoined,jobTitle,isManager,managerEmail,status,sex,nationality,phoneNumber";
        // Create sample data row
        const sampleData = "John,Doe,john.doe@company.com,password123,1990-01-01,2023-01-01,Software Engineer,No,manager@company.com,active,male,American,+1 (555) 123-4567";
        // Combine into CSV content
        csvContent = `${headers}\n${sampleData}`;
        
        // Store it in database for future if admin
        if (req.user?.isAdmin) {
          try {
            await db.insert(fileTemplates).values({
              name: 'employee_import',
              fileName: 'employee_template.csv',
              contentType: 'text/csv',
              content: csvContent,
              description: 'Employee import template in CSV format.',
              createdBy: req.user.id
            });
            console.log("Created employee template in database");
          } catch (err) {
            console.error("Failed to create employee template in database:", err);
          }
        }
      }
      
      // Set headers for CSV download - using text/csv with special headers
      res.setHeader('Content-Type', 'text/csv');
      res.setHeader('Content-Disposition', 'attachment; filename="employee_template.csv"');
      res.setHeader('Content-Description', 'File Transfer');
      res.setHeader('Content-Transfer-Encoding', 'binary');
      res.setHeader('X-Content-Type-Options', 'nosniff');
      res.setHeader('X-Download-Options', 'noopen');
      res.setHeader('X-Permitted-Cross-Domain-Policies', 'none');
      res.setHeader('Referrer-Policy', 'no-referrer');
      
      // Send the CSV directly as text
      res.send(csvContent);
    } catch (error: any) {
      console.error("Error generating template:", error);
      res.status(500).json({ message: "Failed to generate template" });
    }
  });
  
  app.get("/api/hr/template/download", verifyToken, verifyAdmin, async (req: AuthenticatedRequest, res) => {
    try {
      console.log("Template download request received, user:", req.user?.email);
      
      // Check if the employee template exists in the database
